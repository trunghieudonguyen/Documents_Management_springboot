package com.example.documentsmanagement.repository;

import com.example.documentsmanagement.model.Document;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.util.List;

public interface DocumentRepository extends JpaRepository<Document, Long> {

    // =========================================================================
    // üîç T√åM KI·∫æM TO√ÄN VƒÇN (title, documentCode) - kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng
    // =========================================================================
    @Query("""
        SELECT d FROM Document d
        WHERE LOWER(d.title) LIKE LOWER(CONCAT('%', :keyword, '%'))
           OR LOWER(d.documentCode) LIKE LOWER(CONCAT('%', :keyword, '%'))
           OR LOWER(d.department) LIKE LOWER(CONCAT('%', :keyword, '%'))
           OR LOWER(d.area) LIKE LOWER(CONCAT('%', :keyword, '%'))
           OR LOWER(d.status) LIKE LOWER(CONCAT('%', :keyword, '%'))
    """)
    List<Document> searchByKeyword(@Param("keyword") String keyword);

    // =========================================================================
    // ‚úÖ KI·ªÇM TRA S·ª∞ T·ªíN T·∫†I C·ª¶A DOCUMENT CODE (tr√°nh tr√πng m√£)
    // =========================================================================
    boolean existsByDocumentCode(String documentCode);

    // =========================================================================
    // üìã L·ªåC THEO TR·∫†NG TH√ÅI
    // =========================================================================
    List<Document> findByStatus(String status);

    // =========================================================================
    // üè¢ L·ªåC THEO PH√íNG BAN
    // =========================================================================
    List<Document> findByDepartment(String department);

    // =========================================================================
    // üóÇÔ∏è L·ªåC THEO DANH M·ª§C CATEGORY
    // =========================================================================
    @Query("SELECT d FROM Document d WHERE d.category.idDocumentCategory = :categoryId")
    List<Document> findByCategoryId(@Param("categoryId") Long categoryId);

    // =========================================================================
    // ‚ö° L·∫§Y M√É DOCUMENT L·ªöN NH·∫§T THEO PREFIX (t·ªëi ∆∞u cho sinh code)
    // =========================================================================
    @Query("SELECT MAX(d.documentCode) FROM Document d WHERE d.documentCode LIKE CONCAT(:prefix, '%')")
    String findMaxDocumentCodeByPrefix(@Param("prefix") String prefix);

    // =========================================================================
    // üîé H√ÄM SEARCH CHUNG CHO SERVICE
    // =========================================================================
    @Query("""
        SELECT d FROM Document d
        WHERE LOWER(d.title) LIKE :keyword
           OR LOWER(d.documentCode) LIKE :keyword
           OR LOWER(d.department) LIKE :keyword
           OR LOWER(d.area) LIKE :keyword
           OR LOWER(d.status) LIKE :keyword
    """)
    List<Document> findDocumentsByKeyword(@Param("keyword") String keyword);
}
