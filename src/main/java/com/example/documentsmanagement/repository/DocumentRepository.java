package com.example.documentsmanagement.repository;

import com.example.documentsmanagement.model.Document;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface DocumentRepository extends JpaRepository<Document, Long> {

    /** üîç T√¨m ki·∫øm to√†n vƒÉn (title, code, department, area, status) */
    @Query("""
        SELECT d FROM Document d
        WHERE LOWER(d.title) LIKE LOWER(CONCAT('%', :keyword, '%'))
           OR LOWER(d.documentCode) LIKE LOWER(CONCAT('%', :keyword, '%'))
           OR LOWER(d.department) LIKE LOWER(CONCAT('%', :keyword, '%'))
           OR LOWER(d.area) LIKE LOWER(CONCAT('%', :keyword, '%'))
           OR LOWER(d.status) LIKE LOWER(CONCAT('%', :keyword, '%'))
    """)
    List<Document> searchByKeyword(@Param("keyword") String keyword);

    /** üîπ L·ªçc theo tr·∫°ng th√°i */
    List<Document> findByStatus(String status);

    /** üîπ L·ªçc theo ph√≤ng ban */
    List<Document> findByDepartment(String department);

    /** üîπ L·ªçc theo danh m·ª•c (DocumentCategory) */
    @Query("SELECT d FROM Document d WHERE d.category.idDocumentCategory = :categoryId")
    List<Document> findByCategoryId(@Param("categoryId") Long categoryId);

    /** ‚ö° L·∫•y m√£ Document l·ªõn nh·∫•t theo prefix (ƒë·ªÉ sinh m√£ t·ª± ƒë·ªông) */
    @Query("SELECT MAX(d.documentCode) FROM Document d WHERE d.documentCode LIKE CONCAT(:prefix, '%')")
    String findMaxDocumentCodeByPrefix(@Param("prefix") String prefix);

    /** üîπ Ki·ªÉm tra tr√πng m√£ t√†i li·ªáu */
    boolean existsByDocumentCode(String documentCode);
}
