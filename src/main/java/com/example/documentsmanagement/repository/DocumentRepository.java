package com.example.documentsmanagement.repository;

import com.example.documentsmanagement.model.Document;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface DocumentRepository extends JpaRepository<Document, Long> {

    // =========================================================
    // üîç T√åM KI·∫æM TO√ÄN VƒÇN (title, code, department, area, status)
    // Kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng
    // =========================================================
    @Query("""
        SELECT d FROM Document d
        WHERE LOWER(d.title) LIKE LOWER(CONCAT('%', :keyword, '%'))
           OR LOWER(d.documentCode) LIKE LOWER(CONCAT('%', :keyword, '%'))
           OR LOWER(d.department) LIKE LOWER(CONCAT('%', :keyword, '%'))
           OR LOWER(d.area) LIKE LOWER(CONCAT('%', :keyword, '%'))
           OR LOWER(d.status) LIKE LOWER(CONCAT('%', :keyword, '%'))
    """)
    List<Document> searchByKeyword(@Param("keyword") String keyword);

    // =========================================================
    // üîπ L·ªåC THEO TR·∫†NG TH√ÅI
    // =========================================================
    List<Document> findByStatus(String status);

    // =========================================================
    // üîπ L·ªåC THEO PH√íNG BAN
    // =========================================================
    List<Document> findByDepartment(String department);

    // =========================================================
    // üîπ L·ªåC THEO DANH M·ª§C (Category)
    // T·ª± ƒë·ªông n·ªëi quan h·ªá @ManyToOne(category)
    // =========================================================
    List<Document> findByCategory_IdDocumentCategory(Long categoryId);

    // =========================================================
    // ‚ö° L·∫§Y M√É DOCUMENT L·ªöN NH·∫§T THEO PREFIX (ph·ª•c v·ª• sinh m√£ t·ª± ƒë·ªông)
    // N√™n t·∫°o index cho c·ªôt DOCUMENT_CODE ƒë·ªÉ t·ªëi ∆∞u:
    // CREATE INDEX idx_document_code ON DOCUMENT (DOCUMENT_CODE);
    // =========================================================
    @Query("""
        SELECT MAX(d.documentCode)
        FROM Document d
        WHERE d.documentCode LIKE CONCAT(:prefix, '%')
    """)
    String findMaxDocumentCodeByPrefix(@Param("prefix") String prefix);

    // =========================================================
    // üîπ KI·ªÇM TRA M√É DOCUMENT TR√ôNG
    // =========================================================
    boolean existsByDocumentCode(String documentCode);
}
