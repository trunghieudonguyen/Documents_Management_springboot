package com.example.documentsmanagement.service;

import com.example.documentsmanagement.model.Document;
import com.example.documentsmanagement.repository.DocumentRepository;
import jakarta.transaction.Transactional;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

@Service
@Transactional
public class DocumentService {

    private final DocumentRepository repository;

    public DocumentService(DocumentRepository repository) {
        this.repository = repository;
    }

    // =========================================================
    // CRUD C∆† B·∫¢N
    // =========================================================

    public List<Document> findAll() {
        return repository.findAll();
    }

    public Optional<Document> findById(Long id) {
        return repository.findById(id);
    }

    public Document create(Document document) {
        if (document.getCreatedDate() == null) {
            document.setCreatedDate(LocalDate.now());
        }

        // L∆∞u tr∆∞·ªõc ƒë·ªÉ sinh ID (n·∫øu c·∫ßn)
        Document saved = repository.save(document);

        // üîπ Sinh m√£ t√†i li·ªáu duy nh·∫•t (theo nƒÉm + lo·∫°i)
        String code = generateDocumentCode(saved);
        saved.setDocumentCode(code);

        // C·∫≠p nh·∫≠t l·∫°i m√£ ch√≠nh th·ª©c
        return repository.save(saved);
    }

    public Optional<Document> update(Long id, Document updatedData) {
        return repository.findById(id).map(existing -> {
            existing.setTitle(updatedData.getTitle());
            existing.setStatus(updatedData.getStatus());
            existing.setCreatedDate(updatedData.getCreatedDate());
            existing.setEventDate(updatedData.getEventDate());
            existing.setNote(updatedData.getNote());
            existing.setDepartment(updatedData.getDepartment());
            existing.setArea(updatedData.getArea());
            existing.setCategory(updatedData.getCategory());
            // Sinh l·∫°i m√£ n·∫øu thay ƒë·ªïi nƒÉm ho·∫∑c lo·∫°i t√†i li·ªáu
            existing.setDocumentCode(generateDocumentCode(existing));
            return repository.save(existing);
        });
    }

    public void delete(Long id) {
        if (!repository.existsById(id)) {
            throw new IllegalArgumentException("Kh√¥ng t√¨m th·∫•y t√†i li·ªáu c√≥ ID: " + id);
        }
        repository.deleteById(id);
    }

    // =========================================================
    // SINH M√É DOCUMENT CODE ‚Äî C·ª∞C T·ªêI ∆ØU
    // =========================================================
    private synchronized String generateDocumentCode(Document d) {
        // 1Ô∏è‚É£ Th√†nh ph·∫ßn c∆° b·∫£n
        String sign = (d.getCategory() != null && d.getCategory().getSign() != null)
                ? d.getCategory().getSign().toUpperCase()
                : "XX";

        String year = (d.getCreatedDate() != null)
                ? String.valueOf(d.getCreatedDate().getYear()).substring(2)
                : String.valueOf(LocalDate.now().getYear()).substring(2);

        String dept = formatDepartment(d.getDepartment());
        String area = formatArea(d.getArea());

        // 2Ô∏è‚É£ Ti·ªÅn t·ªë
        String prefix = sign + year + dept + area;

        // 3Ô∏è‚É£ T√¨m m√£ l·ªõn nh·∫•t theo prefix (ch·ªâ 1 query, O(1) n·∫øu c√≥ index)
        String maxCode = repository.findMaxDocumentCodeByPrefix(prefix);

        // 4Ô∏è‚É£ T√≠nh s·ªë th·ª© t·ª± k·∫ø ti·∫øp ‚Äî reset m·ªói nƒÉm & m·ªói lo·∫°i (sign)
        int nextNumber = extractNextNumber(maxCode, prefix);

        // 5Ô∏è‚É£ Tr·∫£ v·ªÅ m√£ ho√†n ch·ªânh
        return prefix + String.format("%05d", nextNumber); // 00001‚Äì99999
    }

    /**
     * X·ª≠ l√Ω ph·∫ßn s·ªë th·ª© t·ª± k·∫ø ti·∫øp (tƒÉng d·∫ßn, reset m·ªói nƒÉm + lo·∫°i)
     */
    private int extractNextNumber(String maxCode, String prefix) {
        if (maxCode == null || maxCode.isBlank()) return 1;
        try {
            String numPart = maxCode.substring(prefix.length());
            return Integer.parseInt(numPart) + 1;
        } catch (Exception e) {
            return 1;
        }
    }

    // =========================================================
    // FORMAT D·ªÆ LI·ªÜU ƒê·∫¶U V√ÄO
    // =========================================================
    private String formatArea(String area) {
        if (area == null) return "X";
        String a = area.toLowerCase();

        if (a.contains("h√† n·ªôi") || a.contains("hn") || a.contains("tphn")) return "A";
        if (a.contains("hcm") || a.contains("h·ªì ch√≠ minh")) return "B";
        return "X";
    }

    private String formatDepartment(String department) {
        if (department == null || department.isBlank()) return "XX";
        return department.replace("Ph√≤ng", "P")
                .replace("ph√≤ng", "P")
                .replaceAll("\\s+", "");
    }

    // =========================================================
    // C√ÅC CH·ª®C NƒÇNG PH·ª§ KH√ÅC
    // =========================================================
    public List<Document> search(String keyword) {
        if (keyword == null || keyword.isBlank()) {
            return repository.findAll();
        }
        return repository.searchByKeyword(keyword.toLowerCase());
    }

    public Long count() {
        return repository.count();
    }

    public List<Document> findByStatus(String status) {
        return repository.findByStatus(status);
    }

    public List<Document> findByDepartment(String department) {
        return repository.findByDepartment(department);
    }
}
