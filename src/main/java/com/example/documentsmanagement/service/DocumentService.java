package com.example.documentsmanagement.service;

import com.example.documentsmanagement.model.Document;
import com.example.documentsmanagement.model.DocumentCategory;
import com.example.documentsmanagement.repository.DocumentRepository;
import com.example.documentsmanagement.repository.DocumentCategoryRepository;
import jakarta.transaction.Transactional;
import org.springframework.stereotype.Service;

import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

@Service
@Transactional
public class DocumentService {

    private final DocumentRepository repository;
    private final DocumentCategoryRepository categoryRepository;

    public DocumentService(DocumentRepository repository,
                           DocumentCategoryRepository categoryRepository) {
        this.repository = repository;
        this.categoryRepository = categoryRepository;
    }

    // =========================================================
    // BASIC CRUD OPERATIONS
    // =========================================================

    public List<Document> findAll() {
        return repository.findAll();
    }

    public Optional<Document> findById(Long id) {
        return repository.findById(id);
    }

    public void delete(Long id) {
        if (!repository.existsById(id)) {
            throw new IllegalArgumentException("Kh√¥ng t√¨m th·∫•y t√†i li·ªáu c√≥ ID: " + id);
        }
        repository.deleteById(id);
    }

    // =========================================================
    // CREATE DOCUMENT ‚Äî ƒë·∫£m b·∫£o n·∫°p ƒë·∫ßy ƒë·ªß category tr∆∞·ªõc khi sinh m√£
    // =========================================================
    public Document create(Document document) {
        // G√°n ng√†y t·∫°o m·∫∑c ƒë·ªãnh n·∫øu frontend ch∆∞a g·ª≠i l√™n
        if (document.getCreatedDate() == null) {
            document.setCreatedDate(LocalDate.now());
        }

        // N·∫°p ƒë·∫ßy ƒë·ªß DocumentCategory (n·∫øu ch·ªâ c√≥ id ƒë∆∞·ª£c g·ª≠i l√™n)
        if (document.getCategory() != null && document.getCategory().getIdDocumentCategory() != null) {
            Long categoryId = document.getCategory().getIdDocumentCategory();
            DocumentCategory fullCategory = categoryRepository.findById(categoryId)
                    .orElseThrow(() -> new IllegalArgumentException("Kh√¥ng t√¨m th·∫•y danh m·ª•c c√≥ ID: " + categoryId));
            document.setCategory(fullCategory);
        }

        // üîπ 3. T√≠nh ng√†y h·∫øt h·∫°n d·ª±a v√†o duration (d∆∞·ªõi d·∫°ng String)
        if (document.getCategory() != null && document.getCategory().getDuration() != null) {
            String durationStr = document.getCategory().getDuration().trim().toLowerCase();

            if (durationStr.contains("vƒ©nh vi·ªÖn") || durationStr.contains("kh√¥ng gi·ªõi h·∫°n")) {
                // Vƒ©nh vi·ªÖn => kh√¥ng h·∫øt h·∫°n
                document.setExpirationDate(null);
            } else {
                try {
                    int years = Integer.parseInt(durationStr);
                    document.setExpirationDate(document.getCreatedDate().plusYears(years));
                } catch (NumberFormatException e) {
                    // N·∫øu duration kh√¥ng h·ª£p l·ªá (v√≠ d·ª• "3 nƒÉm" thay v√¨ "3") => b·ªè qua
                    document.setExpirationDate(null);
                }
            }
        } else {
            // N·∫øu kh√¥ng c√≥ duration th√¨ c≈©ng ƒë·∫∑t null
            document.setExpirationDate(null);
        }

        // L∆∞u l·∫ßn ƒë·∫ßu ƒë·ªÉ sinh ID
        Document saved = repository.save(document);

        // Sinh m√£ t√†i li·ªáu t·ª± ƒë·ªông (d·ª±a v√†o category, nƒÉm, ph√≤ng ban, khu v·ª±c...)
        saved.setDocumentCode(generateDocumentCode(saved));

        // L∆∞u l·∫°i b·∫£n ho√†n ch·ªânh v·ªõi m√£
        return repository.save(saved);
    }


    // =========================================================
    // UPDATE DOCUMENT
    // =========================================================
    public Optional<Document> update(Long id, Document updatedData) {
        return repository.findById(id).map(existing -> {
            existing.setTitle(updatedData.getTitle());
            existing.setStatus(updatedData.getStatus());
            existing.setCreatedDate(updatedData.getCreatedDate());
            existing.setEventDate(updatedData.getEventDate());
            existing.setNote(updatedData.getNote());
            existing.setDepartment(updatedData.getDepartment());
            existing.setArea(updatedData.getArea());

            // N·∫°p l·∫°i Category (n·∫øu c√≥ ID)
            if (updatedData.getCategory() != null && updatedData.getCategory().getIdDocumentCategory() != null) {
                Long categoryId = updatedData.getCategory().getIdDocumentCategory();
                DocumentCategory fullCategory = categoryRepository.findById(categoryId)
                        .orElseThrow(() -> new IllegalArgumentException("Kh√¥ng t√¨m th·∫•y danh m·ª•c c√≥ ID: " + categoryId));
                existing.setCategory(fullCategory);
            }

            // C·∫≠p nh·∫≠t ng√†y h·∫øt h·∫°n
            // üîπ C·∫≠p nh·∫≠t ng√†y h·∫øt h·∫°n linh ho·∫°t h∆°n
            if (existing.getCategory() != null && existing.getCategory().getDuration() != null) {
                String durationStr = existing.getCategory().getDuration().trim().toLowerCase();

                try {
                    // N·∫øu l√† s·ªë ho·∫∑c ch·ª©a k√Ω t·ª± "nƒÉm", ch·ªâ l·∫•y ph·∫ßn s·ªë
                    durationStr = durationStr.replaceAll("[^0-9]", "");
                    if (!durationStr.isEmpty()) {
                        int years = Integer.parseInt(durationStr);
                        existing.setExpirationDate(existing.getCreatedDate().plusYears(years));
                    } else if (existing.getCategory().getDuration().contains("vƒ©nh vi·ªÖn") ||
                            existing.getCategory().getDuration().contains("kh√¥ng gi·ªõi h·∫°n")) {
                        existing.setExpirationDate(null);
                    } else {
                        existing.setExpirationDate(null);
                    }
                } catch (Exception e) {
                    existing.setExpirationDate(null);
                }
            }

            // Sinh l·∫°i m√£ t√†i li·ªáu
            existing.setDocumentCode(generateDocumentCode(existing));

            return repository.save(existing);
        });
    }

    // =========================================================
    // üîπ M√É T√ÄI LI·ªÜU T·ª∞ ƒê·ªòNG
    // =========================================================
    private synchronized String generateDocumentCode(Document d) {
        String sign = (d.getCategory() != null && d.getCategory().getSign() != null)
                ? d.getCategory().getSign().toUpperCase()
                : "XX";

        String year = (d.getCreatedDate() != null)
                ? String.valueOf(d.getCreatedDate().getYear()).substring(2)
                : String.valueOf(LocalDate.now().getYear()).substring(2);

        String dept = formatDepartment(d.getDepartment());
        String area = formatArea(d.getArea());

        String prefix = sign + year + dept + area;

        String maxCode = repository.findMaxDocumentCodeByPrefix(prefix);
        int nextNumber = extractNextNumber(maxCode, prefix);

        return prefix + String.format("%05d", nextNumber);
    }

    private int extractNextNumber(String maxCode, String prefix) {
        if (maxCode == null || maxCode.isBlank()) return 1;
        try {
            String numPart = maxCode.substring(prefix.length());
            return Integer.parseInt(numPart) + 1;
        } catch (Exception e) {
            return 1;
        }
    }

    private String formatArea(String area) {
        if (area == null) return "X";
        return switch (area.trim().toLowerCase()) {
            case "h√† n·ªôi" -> "A";
            case "th√†nh ph·ªë h·ªì ch√≠ minh", "tp. h·ªì ch√≠ minh" -> "B";
            default -> "X";
        };
    }

    private String formatDepartment(String department) {
        if (department == null || department.isBlank()) return "XX";
        return department.replace("Ph√≤ng", "P")
                .replace("ph√≤ng", "P")
                .replaceAll("\\s+", "");
    }

    // =========================================================
    // üîπ EXTRA UTILITIES
    // =========================================================
    public List<Document> search(String keyword) {
        if (keyword == null || keyword.isBlank()) return repository.findAll();
        return repository.searchByKeyword(keyword.toLowerCase());
    }

    public List<Document> findByStatus(String status) {
        return repository.findByStatus(status);
    }

    public List<Document> findByDepartment(String department) {
        return repository.findByDepartment(department);
    }

    public List<Document> findByCategoryId(Long categoryId) {
        return repository.findByCategory_IdDocumentCategory(categoryId);
    }

    public Long count() {
        return repository.count();
    }
}
