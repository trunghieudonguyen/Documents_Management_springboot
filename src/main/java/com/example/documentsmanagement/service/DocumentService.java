package com.example.documentsmanagement.service;

import com.example.documentsmanagement.model.Document;
import com.example.documentsmanagement.repository.DocumentRepository;
import jakarta.transaction.Transactional;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;

@Service
@Transactional
public class DocumentService {

    private final DocumentRepository repository;

    public DocumentService(DocumentRepository repository) {
        this.repository = repository;
    }

    // üü¢ L·∫•y t·∫•t c·∫£ t√†i li·ªáu
    public List<Document> findAll() {
        return repository.findAll();
    }

    // üü¢ L·∫•y t√†i li·ªáu theo ID
    public Optional<Document> findById(Long id) {
        return repository.findById(id);
    }

    // üü¢ T·∫°o m·ªõi t√†i li·ªáu
    public Document create(Document document) {
        document.setIdDocument(null); // ƒë·∫£m b·∫£o l√† entity m·ªõi
        return repository.save(document);
    }

    // üü¢ C·∫≠p nh·∫≠t t√†i li·ªáu
    public Optional<Document> update(Long id, Document updatedData) {
        return repository.findById(id).map(existing -> {
            existing.setDocumentCode(updatedData.getDocumentCode());
            existing.setTitle(updatedData.getTitle());
            existing.setDescription(updatedData.getDescription());
            existing.setStatus(updatedData.getStatus());
            existing.setCreatedDate(updatedData.getCreatedDate());
            existing.setEventDate(updatedData.getEventDate());
            existing.setNote(updatedData.getNote());
            existing.setDepartment(updatedData.getDepartment());
            existing.setArea(updatedData.getArea());
            existing.setCategory(updatedData.getCategory());
            return repository.save(existing);
        });
    }

    // üü¢ X√≥a t√†i li·ªáu theo ID
    public void delete(Long id) {
        if (repository.existsById(id)) {
            repository.deleteById(id);
        } else {
            throw new IllegalArgumentException("Kh√¥ng t√¨m th·∫•y t√†i li·ªáu c√≥ ID: " + id);
        }
    }

    // üü¢ T√¨m ki·∫øm t√†i li·ªáu theo ti√™u ƒë·ªÅ ho·∫∑c m√£ (n·∫øu repository c√≥ ph∆∞∆°ng th·ª©c t√¨m ki·∫øm)
    public List<Document> search(String keyword) {
        if (keyword == null || keyword.isBlank()) {
            return repository.findAll();
        }
        return repository.searchByTitle(keyword);
    }

    // üü¢ ƒê·∫øm t·ªïng s·ªë t√†i li·ªáu trong h·ªá th·ªëng
    public long count() {
        return repository.count();
    }

    // üü¢ Ki·ªÉm tra t·ªìn t·∫°i theo m√£ t√†i li·ªáu
    public boolean existsByCode(String documentCode) {
        return repository.existsByDocumentCode(documentCode);
    }

    // üü¢ L·∫•y danh s√°ch t√†i li·ªáu theo tr·∫°ng th√°i
    public List<Document> findByStatus(String status) {
        return repository.findByStatus(status);
    }

    // üü¢ L·∫•y danh s√°ch t√†i li·ªáu theo ph√≤ng ban
    public List<Document> findByDepartment(String department) {
        return repository.findByDepartment(department);
    }
}
